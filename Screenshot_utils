import os
from datetime import datetime
from robot.libraries.BuiltIn import BuiltIn
from robot.api import logger

def get_output_screenshot_dir():
    """
    Returns the screenshot directory inside Robot Framework's output directory.
    Creates the directory if it doesn't exist.
    """
    output_dir = BuiltIn().get_variable_value("${OUTPUT DIR}")
    screenshot_dir = os.path.join(output_dir, "screenshots")
    os.makedirs(screenshot_dir, exist_ok=True)
    return screenshot_dir

def generate_unique_filename(name_prefix="screenshot"):
    """
    Generates a unique filename using current timestamp with microseconds.
    """
    timestamp = datetime.now().strftime("%Y%m%d_%H%M%S_%f")  # microseconds for uniqueness
    return f"{name_prefix}_{timestamp}.png"

def capture_and_embed_screenshot(driver, name_prefix="screenshot", width="800px"):
    """
    Captures a screenshot using the provided WebDriver instance and embeds it in the Robot Framework report.
    """
    screenshot_dir = get_output_screenshot_dir()
    filename = generate_unique_filename(name_prefix)
    path = os.path.join(screenshot_dir, filename)

    driver.save_screenshot(path)
    logger.info(f"ðŸ“¸ Screenshot saved: {path}")

    # Embed image using actual HTML <img> tag
    relative_path = f"screenshots/{filename}"
    html_tag = f'<img src="{relative_path}" width="{width}">'
    BuiltIn().log(html_tag, html=True)

    return path
